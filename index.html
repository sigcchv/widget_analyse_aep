<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dernière analyse réseau d'eau potable</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f4f4f4; }
    #info { margin-top: 1em; font-style: italic; }
  </style>
</head>
<body>
  <h2>Dernière analyse du réseau d’eau potable</h2>
  <div id="info">Chargement...</div>
  <table id="results" style="display:none;">
    <thead>
      <tr>
        <th>Paramètre</th>
        <th>Résultat</th>
        <th>Unité</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function loadData() {
      const codeReseau = getParam("code_reseau");
      if (!codeReseau) {
        document.getElementById("info").textContent = "⚠️ Merci de fournir un code_reseau dans l’URL.";
        return;
      }

      // URL Hub'Eau
      const url = `https://hubeau.eaufrance.fr/api/v1/qualite_eau_potable/resultats_dis?code_reseau=${codeReseau}&size=1000&sort=-date_prelevement`;

      try {
        document.getElementById("info").textContent = "Chargement des données...";
        const res = await fetch(url);
        const data = await res.json();

        if (!data || !data.data || data.data.length === 0) {
          document.getElementById("info").textContent = "❌ Aucun résultat trouvé pour ce réseau.";
          return;
        }

        // Trouver la dernière date de prélèvement
        const derniereDate = data.data[0].date_prelevement;
        const resultatsDerniereAnalyse = data.data.filter(r => r.date_prelevement === derniereDate);

        // Afficher l'info
        document.getElementById("info").textContent = `Dernière analyse : ${derniereDate} (${resultatsDerniereAnalyse.length} paramètres)`;

        // Construire le tableau
        const tbody = document.querySelector("#results tbody");
        tbody.innerHTML = "";
        resultatsDerniereAnalyse.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.libelle_parametre}</td>
            <td>${r.resultat_alphanumerique ?? "-"}</td>
            <td>${r.libelle_unite ?? ""}</td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById("results").style.display = "table";

      } catch (err) {
        document.getElementById("info").textContent = "Erreur API : " + err;
      }
    }

    loadData();
  </script>
</body>
</html>
